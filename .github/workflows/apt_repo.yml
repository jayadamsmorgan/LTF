name: Publish APT Repo

on:
  workflow_run:
    workflows: ["Build .deb (amd64, arm64)"]
    types: [completed]
  workflow_dispatch:
  push:
    branches: ["deb_ci"]

permissions:
  contents: write

concurrency:
  group: gh-pages
  cancel-in-progress: false

jobs:
  publish:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (default branch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: deb-amd64
          path: artifacts/amd64
          run-id: ${{ github.event.workflow_run.id }}

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: deb-arm64
          path: artifacts/arm64
          run-id: ${{ github.event.workflow_run.id }}

      - name: Install repo tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            gnupg apt-utils dpkg-dev gzip rsync

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Import signing key
        env:
          APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          echo "${APT_GPG_PRIVATE_KEY}" | gpg --batch --import

      - name: Update gh-pages /apt only
        env:
          APT_GPG_PASSPHRASE: ${{ secrets.APT_GPG_PASSPHRASE }}
        run: |
          set -euo pipefail

          SUITE="stable"
          COMP="main"

          # Worktree for gh-pages
          rm -rf .gh-pages
          git fetch origin gh-pages:gh-pages || true
          git worktree add .gh-pages gh-pages 2>/dev/null || {
            git checkout --orphan gh-pages
            git reset --hard
            git worktree add .gh-pages gh-pages
          }

          APT_ROOT=".gh-pages/apt"
          rm -rf "${APT_ROOT}"
          mkdir -p "${APT_ROOT}/pool/${COMP}"
          mkdir -p "${APT_ROOT}/dists/${SUITE}/${COMP}/binary-amd64"
          mkdir -p "${APT_ROOT}/dists/${SUITE}/${COMP}/binary-arm64"

          # Copy .debs into pool
          cp -v artifacts/amd64/*.deb "${APT_ROOT}/pool/${COMP}/"
          cp -v artifacts/arm64/*.deb "${APT_ROOT}/pool/${COMP}/"

          # Generate Packages + Packages.gz per arch
          pushd "${APT_ROOT}" >/dev/null
          dpkg-scanpackages --arch amd64 "pool/${COMP}" > "dists/${SUITE}/${COMP}/binary-amd64/Packages"
          gzip -9c "dists/${SUITE}/${COMP}/binary-amd64/Packages" > "dists/${SUITE}/${COMP}/binary-amd64/Packages.gz"

          dpkg-scanpackages --arch arm64 "pool/${COMP}" > "dists/${SUITE}/${COMP}/binary-arm64/Packages"
          gzip -9c "dists/${SUITE}/${COMP}/binary-arm64/Packages" > "dists/${SUITE}/${COMP}/binary-arm64/Packages.gz"

          # Release + signing
          cd "dists/${SUITE}"
          {
            echo "Origin: LTF"
            echo "Label: LTF"
            echo "Suite: ${SUITE}"
            echo "Codename: ${SUITE}"
            echo "Components: ${COMP}"
            echo "Architectures: amd64 arm64"
            echo "Description: LTF APT repository"
            echo "Date: $(date -Ru)"
            echo
            apt-ftparchive release .
          } > Release

          if [ -n "${APT_GPG_PASSPHRASE:-}" ]; then
            gpg --batch --yes --pinentry-mode loopback --passphrase "${APT_GPG_PASSPHRASE}" \
              --clearsign -o InRelease Release
            gpg --batch --yes --pinentry-mode loopback --passphrase "${APT_GPG_PASSPHRASE}" \
              -abs -o Release.gpg Release
          else
            gpg --batch --yes --clearsign -o InRelease Release
            gpg --batch --yes -abs -o Release.gpg Release
          fi

          popd >/dev/null

          # Export public key into the hosted repo (THIS ANSWERS "WHERE SHOULD IT GO")
          mkdir -p "${APT_ROOT}/keys"
          gpg --batch --yes --export > "${APT_ROOT}/keys/ltf-archive-keyring.gpg"
          gpg --batch --yes --armor --export > "${APT_ROOT}/keys/ltf-archive-keyring.asc"
          chmod 0644 "${APT_ROOT}/keys/ltf-archive-keyring.gpg"

          # Commit only gh-pages changes
          cd .gh-pages
          touch .nojekyll
          git add -A
          if git diff --cached --quiet; then
            echo "No APT repo changes."
            exit 0
          fi
          git commit -m "apt: publish repo"
          git push origin gh-pages
